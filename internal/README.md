Code copied from Go source.